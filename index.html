<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load the SVG.js library -->
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
	<link rel="stylesheet" href="./coloris.min.css"/>
	<script src="./coloris.min.js"></script>
    <title>Image Recoloring Filter</title>
</head>

<body>
    <div id='controls'>
        <label for='frameColor'>Frame<input type='text' data-coloris id='frameColor' value='#f2ce4a'></label>
        <label for='bodyColor'>Inside<input type='text' data-coloris id='bodyColor' value='#FFF'></label>
        <label for='frameColorStrokeWidth'>Stroke Width<input type='text' id='frameColorStrokeWidth' value='15'></label>
    </div>
    <button id="convertToPNG">Convert to PNG</button>

    <div id='svg-box' class='graphic-container'></div>
    <div id='png-container' class='graphic-container'></div>

    <script>
        const frameColorPicker = document.getElementById('frameColor');
		const bodyColorPicker = document.getElementById('bodyColor');
		const frameColorStrokeWidth = document.getElementById('frameColorStrokeWidth');
		Coloris({
			theme: 'pill'
		})

        let draw = SVG().addTo('#svg-box');
        let frame;

        frameColorPicker.addEventListener('input', ()=>{setColor({ el:'#color-frame', property: 'stroke' }, frameColorPicker.value)}, false);
		bodyColorPicker.addEventListener('input', ()=>{setColor({ el: '#frame-body', property: 'fill' }, bodyColorPicker.value)}, false);
		frameColorStrokeWidth.addEventListener('input', ()=>{setColor({ el: '#color-frame', property: 'stroke-width' }, frameColorStrokeWidth.value + 'px')}, false);

        // Call updateColor once when the page loads to initialize the SVG with the default color
        loadSVG();

        async function setColor(target, value) {
            // Update the color of the SVG element
			if(frame.findOne(target.el).node.children.length > 0){
				frame.findOne(target.el).each(function () {
					this.css(target.property, value);
				});

			} else {
				frame.findOne(target.el).css(target.property, value);
			}
        }

        async function loadSVG() {
            var ajax = new XMLHttpRequest();
            ajax.open('GET', './frame.svg', true);
            ajax.send();
            await new Promise((resolve, reject) => {
                ajax.onload = function (e) {
                    // Clear existing SVG content
                    draw.clear();
                    // Draw new SVG content
                    frame = draw.svg(ajax.responseText);
                    frame.size(522, 422);
					setColor({ el: '#color-frame', property: 'stroke'}, frameColorPicker.value);
                    // Resolve the promise when the SVG is drawn
                    resolve();
                };
                ajax.onerror = function (error) {
                    // Reject the promise if there's an error with the AJAX request
                    reject(error);
                };
            });
        }

            // Button click event to convert SVG to PNG
			document.getElementById('convertToPNG').addEventListener('click', () => {
            const svgString = frame.svg();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 522;
            canvas.height = 422;
            const DOMURL = self.URL || self.webkitURL || self;
            const img = new Image();
            const svg = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = DOMURL.createObjectURL(svg);
            img.onload = function () {
                ctx.drawImage(img, 0, 0);
                var png = canvas.toDataURL('image/png');
                document.querySelector('#png-container').innerHTML = `<img src="${png}">`;
                DOMURL.revokeObjectURL(png);
            }
            img.src = url;
        });
    </script>
</body>
<style>
    body {
        background: #666;
		color: #EFEFEF;
		font-family: sans-serif;
        & svg {
            border: 1px solid #777;
            margin: 10px 0;
        }
        & #controls {
            display: flex;
            flex-direction: column;
            gap: 1em;
            margin: 10px 0;
            width: 350px;
            & label *:first-child {
                margin-left: 15px;
            }

        }
    }
</style>

</html>
